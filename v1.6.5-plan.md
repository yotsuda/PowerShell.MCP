# v1.6.5 リリース計画

## テーマ: invoke_command + invoke_pipeline リネーム

AI エージェントがテキスト内容をパラメータに渡す際の PowerShell エスケープ問題を根本解決する。

## 背景

- `invoke_expression` (現行) は pipeline 文字列を PowerShell パーサーに渡すため、`$`, `` ` ``, `"` が解釈される
- ファイル編集 cmdlet の `-OldText`, `-Replacement`, `-Content` 等に `$variable` を含むコードを渡すと意図しない展開が起きる
- ここ文字列 (`@'...'@`) で回避可能だが、AI エージェントにとって一貫したエスケープは困難

## 変更内容

### 1. 新 MCP ツール: `invoke_command`

単一コマンドに JSON パラメータを直接渡す。PowerShell パーサーをバイパスする。

**パラメータ:**

| 名前 | 型 | 必須 | 説明 |
|---|---|---|---|
| command | string | Yes | コマンド名 (cmdlet or CLI) |
| arguments | string[] | No | 位置引数 (CLI 用) |
| parameters | object | No | 名前付きパラメータ (cmdlet 用) |
| agent_id | string | No | エージェント ID |
| timeout_seconds | integer | No | タイムアウト (default: 170) |

**JSON → PowerShell 型マッピング:**

| JSON 型 | PowerShell 型 | 渡し方 |
|---|---|---|
| string | String | `.AddParameter(name, value)` |
| number | Int32 | `.AddParameter(name, value)` |
| true | SwitchParameter | `.AddParameter(name)` |
| false / null | — | パラメータ省略 |
| string[] | String[] | `.AddParameter(name, array)` |
| number[] | Int32[] | `.AddParameter(name, array)` |

**使用例:**

```json
// Cmdlet: エスケープ不要でテキスト内容を渡せる
{
  "command": "Update-MatchInFile",
  "parameters": {
    "Path": "script.ps1",
    "OldText": "$helpFile = Join-Path $tempOutputPath \"file.xml\"",
    "Replacement": "$helpFiles = Get-ChildItem $tempOutputPath -Filter \"*.xml\""
  }
}

// CLI: git commit メッセージに $ を含む
{
  "command": "git",
  "arguments": ["commit", "-m", "Fix $variable handling in parser"]
}
```

**実装方針:**
- `AddCommand` + `AddParameter` / `AddArgument` で PowerShell Runspace に直接投入
- 既存のコンソールセッション、出力キャプチャ、タイムアウト機構を流用
- native command (git, dotnet 等) にも `AddCommand` + `AddArgument` で対応可能

### 2. リネーム: `invoke_expression` → `invoke_pipeline`

- MCP ツール名を変更: `invoke_expression` → `invoke_pipeline`
- ツール description 更新: パイプライン文字列を実行するツールであることを明記
- `invoke_expression` は後方互換のため非推奨エイリアスとして残す (将来削除)

### 3. ツール description 更新

3つのツールの使い分けを description に記載:

| ツール | 用途 | 例 |
|---|---|---|
| invoke_pipeline | パイプライン、変数、制御構文 | `Get-ChildItem \| Where-Object {...}` |
| invoke_command | 特殊文字を含むパラメータ | ファイル編集、コミットメッセージ |
| start_powershell_console | セッション開始 | — |

## 実装順序

1. `invoke_command` ツールハンドラ実装
2. JSON → PowerShell 型変換ロジック (ConvertValue)
3. 既存 invoke_expression のリネーム + エイリアス
4. ツール description 更新
5. テスト: cmdlet 呼び出し ($, バッククォート, 改行を含むパラメータ)
6. テスト: CLI 呼び出し (git, dotnet)
7. テスト: 後方互換 (invoke_expression エイリアス)

## テスト計画

- `$variable` を含む OldText/Replacement での Update-MatchInFile
- multiline Content での Update-LinesInFile
- `git commit -m "message with $special"` での CLI 呼び出し
- SwitchParameter (WhatIf: true/false)
- 配列パラメータ (LineRange: [10, 20])
- invoke_expression エイリアスの後方互換

## リスク

- native command の引数渡しで PowerShell の ArgumentList 処理が介入する可能性
  → `StartProcessCommand` ではなく `AddCommand` + `AddArgument` で検証が必要
- MCP クライアント (Claude Code, Copilot) のツール description キャッシュ
  → リネーム時に旧名が残る可能性。エイリアスで対処