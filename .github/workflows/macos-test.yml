name: macOS Test

on:
  workflow_dispatch:  # Manual trigger

jobs:
  test-macos:
    runs-on: macos-14  # M1 Mac (arm64)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Install PowerShell
      run: |
        brew install powershell/tap/powershell
        pwsh --version
    
    - name: Build PowerShell.MCP module
      run: |
        dotnet build PowerShell.MCP -c Release --no-incremental
    
    - name: Build Proxy (osx-arm64)
      run: |
        dotnet publish PowerShell.MCP.Proxy -c Release -r osx-arm64 --self-contained
    
    - name: Setup module directory
      run: |
        MODULE_PATH="$HOME/.local/share/powershell/Modules/PowerShell.MCP"
        mkdir -p "$MODULE_PATH/bin/osx-arm64"
        
        # Copy DLLs
        cp PowerShell.MCP/bin/Release/net9.0/PowerShell.MCP.dll "$MODULE_PATH/"
        cp PowerShell.MCP/bin/Release/net9.0/Ude.NetStandard.dll "$MODULE_PATH/"
        
        # Copy manifest and script
        cp Staging/PowerShell.MCP.psd1 "$MODULE_PATH/"
        cp Staging/PowerShell.MCP.psm1 "$MODULE_PATH/"
        
        # Copy Proxy
        cp PowerShell.MCP.Proxy/bin/Release/net9.0/osx-arm64/publish/PowerShell.MCP.Proxy "$MODULE_PATH/bin/osx-arm64/"
        chmod +x "$MODULE_PATH/bin/osx-arm64/PowerShell.MCP.Proxy"
        
        echo "Module files:"
        ls -la "$MODULE_PATH/"
        ls -la "$MODULE_PATH/bin/osx-arm64/"
    
    - name: Test module import
      run: |
        pwsh -NoProfile -Command '
          $ErrorActionPreference = "Stop"
          
          Write-Host "=== Importing module ===" -ForegroundColor Cyan
          Import-Module PowerShell.MCP -Verbose
          
          Write-Host "`n=== Module info ===" -ForegroundColor Cyan
          Get-Module PowerShell.MCP | Format-List Name, Version, ModuleBase
          
          Write-Host "`n=== Get-MCPProxyPath ===" -ForegroundColor Cyan
          $proxyPath = Get-MCPProxyPath
          Write-Host "Proxy path: $proxyPath"
          if (-not (Test-Path $proxyPath)) { throw "Proxy not found at $proxyPath" }
          
          Write-Host "`n=== PSReadLine status ===" -ForegroundColor Cyan
          $psrl = Get-Module PSReadLine
          if ($psrl) {
            Write-Host "PSReadLine is loaded (unexpected on macOS)" -ForegroundColor Yellow
          } else {
            Write-Host "PSReadLine is NOT loaded (expected on macOS)" -ForegroundColor Green
          }
          
          Write-Host "`n=== All tests passed ===" -ForegroundColor Green
        '
    
    - name: Test Proxy and Named Pipe communication
      run: |
        pwsh -NoProfile -Command '
          $ErrorActionPreference = "Stop"
          
          Write-Host "=== Starting Proxy ===" -ForegroundColor Cyan
          $proxyPath = Get-MCPProxyPath
          
          # Start Proxy in background
          $proxy = Start-Process -FilePath $proxyPath -PassThru -RedirectStandardInput proxy_stdin.txt -RedirectStandardOutput proxy_stdout.txt -RedirectStandardError proxy_stderr.txt
          
          Start-Sleep -Seconds 2
          
          Write-Host "Proxy PID: $($proxy.Id)"
          
          # Send initialize request
          $initRequest = ''{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}''
          $initRequest | Out-File -FilePath proxy_stdin.txt -Encoding utf8
          
          Start-Sleep -Seconds 2
          
          Write-Host "`n=== Proxy stderr ===" -ForegroundColor Yellow
          if (Test-Path proxy_stderr.txt) { Get-Content proxy_stderr.txt }
          
          Write-Host "`n=== Proxy stdout ===" -ForegroundColor Yellow
          if (Test-Path proxy_stdout.txt) { Get-Content proxy_stdout.txt }
          
          # Cleanup
          Stop-Process -Id $proxy.Id -Force -ErrorAction SilentlyContinue
          
          Write-Host "`n=== Proxy test completed ===" -ForegroundColor Green
        '
