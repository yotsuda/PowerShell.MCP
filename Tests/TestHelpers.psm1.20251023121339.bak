# テスト用ヘルパー関数

<#
.SYNOPSIS
例外が静かにスローされることを検証するヘルパー関数

.DESCRIPTION
Should -Throw の代わりに使用することで、例外の詳細な出力を抑制し、
例外が正しくスローされたことだけを簡潔に検証します。

.PARAMETER ScriptBlock
実行するスクリプトブロック（例外をスローすることが期待される）

.PARAMETER ExpectedMessage
期待される例外メッセージのパターン（オプション）

.EXAMPLE
Test-ThrowsQuietly { Add-LinesToFile -Path $file -Content @() } -ExpectedMessage "empty array"

.EXAMPLE
Test-ThrowsQuietly { Update-LinesInFile -Path $file -LineRange @(0, 10) }
#>
function Test-ThrowsQuietly {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ScriptBlock]$ScriptBlock,
        
        [Parameter(Mandatory = $false)]
        [string]$ExpectedMessage
    )
    
    $caught = $false
    $exceptionMessage = $null
    
    try {
        # -ErrorAction Stop を強制して例外を確実にキャッチ
        & $ScriptBlock -ErrorAction Stop
    }
    catch {
        $caught = $true
        $exceptionMessage = $_.Exception.Message
    }
    
    # 例外がスローされたことを検証
    $caught | Should -BeTrue -Because "An exception should have been thrown"
    
    # 期待されるメッセージが指定されている場合、メッセージを検証
    if ($ExpectedMessage) {
        $exceptionMessage | Should -Match $ExpectedMessage -Because "Exception message should match the expected pattern"
    }
}

<#
.SYNOPSIS
パラメータバリデーション例外を静かに検証するヘルパー関数

.DESCRIPTION
パラメータバインディングエラーを簡潔に検証します。
これらのエラーは特に詳細な出力が多いため、専用の関数を用意しました。

.PARAMETER ScriptBlock
実行するスクリプトブロック（パラメータエラーが期待される）

.EXAMPLE
Test-ParameterValidationError { Add-LinesToFile -Path $file -Content @() }
#>
function Test-ParameterValidationError {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ScriptBlock]$ScriptBlock
    )
    
    $caught = $false
    
    try {
        & $ScriptBlock 2>$null  # 標準エラーを抑制
    }
    catch {
        $caught = $true
        # パラメータバリデーションエラーであることを確認
        $_.Exception.GetType().Name | Should -Match "ParameterBindingException|ParameterBindingValidationException"
    }
    
    $caught | Should -BeTrue -Because "A parameter validation error should have been thrown"
}

# Export functions
Export-ModuleMember -Function Test-ThrowsQuietly, Test-ParameterValidationError